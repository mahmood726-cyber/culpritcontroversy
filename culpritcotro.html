<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RevascLogic v1.2: The Completeness Paradox</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    /* --- Theme: "Hemodynamic Flux" --- */
    :root {
      --bg-dark: #09090b;
      --bg-panel: #18181b;
      --bg-input: #27272a;
      --primary: #3b82f6;       /* Procedure Blue */
      --complete: #10b981;      /* Complete Revasc (Green) */
      --culprit: #f59e0b;       /* Culprit Only (Amber) */
      --harm: #ef4444;          /* Death/Renal (Red) */
      --text-main: #e4e4e7;
      --text-muted: #a1a1aa;
      --border: #3f3f46;
      --font-sans: 'Inter', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --font-display: 'Space Grotesk', sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; }
    body { background: var(--bg-dark); color: var(--text-main); font-family: var(--font-sans); display: flex; }
    
    .app-shell { display: grid; grid-template-columns: 350px 1fr 320px; width: 100%; height: 100%; }
    
    .sidebar { background: var(--bg-panel); display: flex; flex-direction: column; overflow: hidden; border-right: 1px solid var(--border); z-index: 10; }
    .sidebar-right { border-left: 1px solid var(--border); border-right: none; background: var(--bg-panel); }
    .scroll-area { padding: 20px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 24px; }
    
    .main-stage { padding: 0; display: flex; flex-direction: column; overflow-y: auto; background: radial-gradient(circle at 50% 10%, #1e1b4b 0%, #09090b 60%); position: relative; }

    /* Typography */
    h1 { font-family: var(--font-display); font-size: 1.25rem; font-weight: 700; color: #fff; letter-spacing: -0.02em; }
    h2 { font-size: 0.7rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 10px; border-bottom: 1px solid var(--border); padding-bottom: 4px; }
    
    /* Preset Buttons */
    .preset-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
    .preset-btn { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-muted); padding: 8px; border-radius: 6px; font-size: 0.7rem; cursor: pointer; transition: all 0.2s; text-align: center; }
    .preset-btn:hover { border-color: var(--primary); color: #fff; }
    .preset-btn.active { background: rgba(59, 130, 246, 0.1); border-color: var(--primary); color: var(--primary); font-weight: 600; }

    /* Trial Toggles */
    .trial-list { display: flex; flex-direction: column; gap: 2px; }
    .trial-row { display: flex; align-items: center; justify-content: space-between; padding: 8px; background: var(--bg-input); border-radius: 4px; border: 1px solid transparent; cursor: pointer; transition: all 0.2s; }
    .trial-row:hover { border-color: #555; }
    .trial-row.excluded { opacity: 0.4; background: transparent; border: 1px dashed var(--border); }
    .trial-name { font-size: 0.8rem; font-weight: 600; }
    .trial-meta { font-size: 0.65rem; color: var(--text-muted); }
    .trial-tag { font-size: 0.6rem; padding: 2px 4px; border-radius: 3px; font-weight: 700; text-transform: uppercase; margin-left: 6px; }
    .tag-shock { background: #450a0a; color: #fca5a5; }
    .tag-stable { background: #064e3b; color: #6ee7b7; }
    
    /* Risk Sliders */
    .control-group { display: flex; flex-direction: column; gap: 6px; }
    .lbl-row { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted); }
    .val-badge { font-family: var(--font-mono); color: #fff; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; }
    
    input[type="range"] { -webkit-appearance: none; width: 100%; height: 4px; background: #333; border-radius: 2px; outline: none; margin: 8px 0; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: var(--text-main); border-radius: 50%; cursor: pointer; border: 2px solid var(--bg-panel); }

    /* Viz Layout */
    .narrative-box { padding: 40px 40px 20px 40px; max-width: 1200px; margin: 0 auto; width: 100%; }
    .narrative-title { font-family: var(--font-display); font-size: 2rem; font-weight: 700; color: #fff; line-height: 1.1; margin-bottom: 8px; }
    .narrative-sub { font-family: var(--font-sans); font-size: 0.9rem; color: var(--text-muted); }
    
    .viz-grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 20px; padding: 0 40px 40px 40px; max-width: 1200px; margin: 0 auto; width: 100%; }
    .viz-col-full { grid-column: 1 / -1; }
    
    .viz-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; min-height: 300px; position: relative; }
    .viz-header { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); }
    .viz-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.05em; }
    
    canvas { width: 100%; height: 100%; display: block; }
    
    /* Metrics */
    .metric-box { padding: 16px; background: var(--bg-input); border-radius: 8px; border-left: 3px solid #555; margin-bottom: 12px; }
    .m-head { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
    .m-val { font-size: 1.5rem; font-family: var(--font-mono); font-weight: 700; color: #fff; }
    .m-sub { font-size: 0.75rem; color: #777; margin-top: 4px; }
    .outcome-complete { border-color: var(--complete); }
    .outcome-culprit { border-color: var(--culprit); }
    
    /* Report */
    .report-area { font-family: var(--font-mono); font-size: 0.75rem; color: #d4d4d8; line-height: 1.6; padding: 20px; background: rgba(0,0,0,0.3); }
    
    .loader { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.2); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
    .run-btn { width: 100%; padding: 12px; background: #fff; color: #000; font-weight: 700; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: auto; }
    .run-btn:hover { background: #e4e4e7; }
    .run-btn.processing .loader { display: block; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 1200px) { .app-shell { grid-template-columns: 320px 1fr; } .sidebar-right { display: none; } }
  </style>
</head>
<body>

<div class="app-shell">
  <!-- SIDEBAR: CONTROLS -->
  <aside class="sidebar">
    <div class="scroll-area">
      <div>
        <h1>RevascLogic</h1>
        <p style="font-size:0.75rem; color:var(--text-muted);">v1.2 | Calibrated Data Engine</p>
      </div>

      <!-- Presets -->
      <div class="control-group">
        <h2>Load Scenario</h2>
        <div class="preset-grid">
          <div class="preset-btn active" id="btnCritique" onclick="loadPreset('critique')">Stable Only<br>(Consensus)</div>
          <div class="preset-btn" id="btnJacc" onclick="loadPreset('jacc')">JACC 2024<br>(Mixed)</div>
          <div class="preset-btn" id="btnShock" onclick="loadPreset('shock')">Shock Only<br>(CULPRIT)</div>
          <div class="preset-btn" id="btnAll" onclick="loadPreset('all')">All-Comers<br>(High Het)</div>
        </div>
      </div>

      <!-- Trial Selector -->
      <div class="control-group">
        <h2>Included Trials (Sensitivity)</h2>
        <div class="trial-list" id="trialList">
          <!-- Injected via JS -->
        </div>
      </div>

      <!-- Parameters -->
      <div class="control-group">
        <h2>Population Risk</h2>
        <div class="lbl-row">
          <span>Baseline Mortality/Renal Risk</span>
          <span id="lblRisk" class="val-badge">5.0%</span>
        </div>
        <input type="range" id="riskInput" min="1" max="50" value="5" step="0.5">
        
        <div class="lbl-row" style="margin-top:10px;">
          <span>Complete Revasc Harm Penalty</span>
          <span id="lblHarm" class="val-badge">1.1x</span>
        </div>
        <input type="range" id="harmInput" min="1.0" max="2.0" value="1.1" step="0.05">
        <div style="font-size:0.65rem; color:#555;">Odds of Renal/Death increase due to longer procedure.</div>
      </div>
      
      <button class="run-btn" id="runBtn" onclick="runSimulation()">
        <div class="loader"></div>
        <span>Analyze Evidence</span>
      </button>
    </div>
  </aside>

  <!-- MAIN: VIZ -->
  <main class="main-stage">
    <div class="narrative-box">
      <div class="narrative-sub">META-ANALYSIS RECONSTRUCTION (HKSJ)</div>
      <div id="narrativeTitle" class="narrative-title">Evidence Supports Complete Revascularization</div>
      <div id="narrativeSub" class="narrative-sub">Based on selected trials, treating non-culprit lesions reduces MACE without significant safety penalty.</div>
    </div>

    <!-- Forest Plot -->
    <div class="viz-grid">
      <div class="viz-card viz-col-full" style="height: 320px;">
        <div class="viz-header">
          <span class="viz-label">Forest Plot: MACE vs. HARD SAFETY (Mortality/Renal)</span>
          <span class="viz-label" id="hetBadge" style="color:#fbbf24">I² = 0%</span>
        </div>
        <canvas id="forestCanvas"></canvas>
      </div>

      <!-- Waffle -->
      <div class="viz-card" style="height: 320px;">
        <div class="viz-header">
          <span class="viz-label">The 100 Patient Room (Competing Risks)</span>
        </div>
        <canvas id="waffleCanvas"></canvas>
      </div>

      <!-- Distribution -->
      <div class="viz-card" style="height: 320px;">
        <div class="viz-header">
          <span class="viz-label">Probabilistic Outcome (Monte Carlo)</span>
        </div>
        <canvas id="distCanvas"></canvas>
      </div>
    </div>

    <div class="viz-grid">
       <div class="viz-card viz-col-full" style="min-height: auto;">
          <div class="viz-header">
             <span class="viz-label">Methodological Critique</span>
          </div>
          <div id="reportContent" class="report-area">...</div>
       </div>
    </div>
  </main>

  <!-- RIGHT: METRICS -->
  <aside class="sidebar sidebar-right">
    <div class="scroll-area">
      <h2>Pooled Estimates</h2>
      
      <div class="metric-box outcome-complete">
        <div class="m-head">Efficacy (Prevent MI)</div>
        <div class="m-val" id="valEffOR" style="color:var(--complete)">--</div>
        <div class="m-sub">Pooled OR (HKSJ)</div>
        <div class="m-sub" id="valEffCI" style="opacity:0.6">95% CI</div>
      </div>

      <div class="metric-box outcome-culprit">
        <div class="m-head">Hard Safety (Death/Renal)</div>
        <div class="m-val" id="valSafOR" style="color:var(--culprit)">--</div>
        <div class="m-sub">Pooled OR (HKSJ)</div>
        <div class="m-sub" id="valSafCI" style="opacity:0.6">95% CI</div>
      </div>

      <div class="metric-box" style="border-color: #fff;">
        <div class="m-head">Net Clinical Benefit</div>
        <div class="m-val" id="valNCB">--%</div>
        <div class="m-sub">Abs. Risk Difference</div>
      </div>

      <div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border);">
        <h2>Trial Impact</h2>
        <div style="font-size:0.75rem; color:var(--text-muted); line-height:1.5;">
          <span style="color:#fff; font-weight:700;">CULPRIT-SHOCK:</span> 
          Excluded in the JACC analysis. Inclusion typically neutralizes safety benefits.
        </div>
        <div style="font-size:0.75rem; color:var(--text-muted); line-height:1.5; margin-top:10px;">
          <span style="color:#fff; font-weight:700;">FIRE:</span> 
          Driver of positive mortality data in recent guidelines. NSTEMI/Elderly population.
        </div>
      </div>
    </div>
  </aside>
</div>

<!-- WORKER -->
<script id="worker-code" type="javascript/worker">
  self.onmessage = function(e) {
    const { trials, baselineRisk, harmPenalty, nSims } = e.data;
    
    // 1. Filter Active
    const activeTrials = trials.filter(t => t.active);
    if(activeTrials.length === 0) { self.postMessage({error:true}); return; }

    // 2. Run Meta-Analysis (HKSJ Adjustment)
    // We run DSL first to get weights, then apply HKSJ correction
    const maEff = runHKSJ(activeTrials, 'logOR_eff', 'se_eff');
    const maSaf = runHKSJ(activeTrials, 'logOR_saf', 'se_saf');

    // 3. Monte Carlo (Correlated Competing Risks)
    // Correlation between Safety and Efficacy (Better centers do both better)
    const rho = 0.5;
    
    let ratioMI = baselineRisk > 0.20 ? 0.6 : 2.0; 
    const baseRiskMI = baselineRisk * ratioMI;
    const baseRiskSafe = baselineRisk;

    const ncbDist = [];
    let completeWins = 0;

    for(let i=0; i<nSims; i++) {
        // Generate Correlated Z-scores
        let u1=Math.random(), u2=Math.random();
        let u3=Math.random(), u4=Math.random();
        
        let z_eff_indep = Math.sqrt(-2*Math.log(u1))*Math.cos(2*Math.PI*u2);
        let z_saf_indep = Math.sqrt(-2*Math.log(u3))*Math.cos(2*Math.PI*u4);
        
        let z_eff = z_eff_indep;
        // Correlate Safety with Efficacy
        let z_saf = (rho * z_eff_indep) + (Math.sqrt(1 - rho*rho) * z_saf_indep);

        let simOR_eff = Math.exp(maEff.mu + z_eff * maEff.se_pool);
        let simOR_saf = Math.exp(maSaf.mu + z_saf * maSaf.se_pool) * harmPenalty;

        // Calculate Absolute Risks (Complete Revasc Group)
        let riskMI_comp = (baseRiskMI * simOR_eff) / (1 - baseRiskMI + (baseRiskMI * simOR_eff));
        let riskSafe_comp = (baseRiskSafe * simOR_saf) / (1 - baseRiskSafe + (baseRiskSafe * simOR_saf));

        // Competing Risk Logic (Hierarchy)
        // Draw outcomes for Complete Arm
        let outcome = 'neutral';
        
        // Safety Event Check (Death/Renal) - Trumps MI
        if(Math.random() < riskSafe_comp) {
            outcome = 'harm';
        } 
        // If survived, check for MI
        else if (Math.random() < riskMI_comp) {
            outcome = 'mi';
        }

        // Compare against Baseline (Expected)
        // Baseline Expected MI count = baseRiskMI
        // Baseline Expected Safety count = baseRiskSafe
        
        // This is a Risk Difference Simulation, slightly abstracted
        let diff_safe = riskSafe_comp - baseRiskSafe; // + means Harm
        let diff_mi = riskMI_comp - baseRiskMI;       // - means Benefit
        
        // Net Clinical Benefit: (Benefit) - (Harm)
        // Benefit = Saved MI (-diff_mi)
        // Harm = Caused Death (+diff_safe)
        let ncb = (-diff_mi) - (diff_safe);
        
        ncbDist.push(ncb);
        if(ncb > 0) completeWins++;
    }
    
    ncbDist.sort((a,b) => a-b);
    const meanNCB = ncbDist.reduce((a,b)=>a+b,0)/nSims;
    const probComplete = completeWins / nSims;

    self.postMessage({
        type: 'complete',
        results: {
            maEff,
            maSaf,
            meanNCB,
            probComplete,
            ncbDist: downsample(ncbDist, 100),
            baseRiskMI,
            baseRiskSafe
        }
    });
  };

  // Hartung-Knapp-Sidik-Jonkman (HKSJ) Implementation
  function runHKSJ(data, kEff, kSe) {
    const y = data.map(d => d[kEff]);
    const v = data.map(d => d[kSe]**2);
    
    // 1. Standard DSL for Tau2 and Initial Weights
    const wFE = v.map(x => 1/x);
    const swFE = wFE.reduce((a,b)=>a+b,0);
    const muFE = wFE.reduce((a,b,j)=>a+b*y[j],0)/swFE;
    
    let Q = 0; y.forEach((val, i) => Q += wFE[i]*(val-muFE)**2);
    const k = data.length;
    const df = k - 1;
    const C = swFE - wFE.reduce((a,b)=>a+b*b,0)/swFE;
    const tau2 = Math.max(0, (Q - df)/C);
    const I2 = Math.max(0, (Q-df)/Q)*100;

    // 2. HKSJ Refinement
    const wRE = v.map(x => 1/(x+tau2));
    const swRE = wRE.reduce((a,b)=>a+b,0);
    const muRE = wRE.reduce((a,b,j)=>a+b*y[j],0)/swRE;
    
    // HKSJ Variance Inflation
    let q_term = 0;
    y.forEach((val, i) => q_term += wRE[i] * (val - muRE)**2);
    
    let var_hksj = 0;
    if (k > 1) {
       var_hksj = (q_term / ((k-1) * swRE));
       // Safety clamp: HKSJ variance shouldn't be insanely small if Q is small, but strictly it replaces DSL SE.
       // However, often implemented as Max(var_DSL, var_HKSJ) or strictly var_HKSJ. 
       // We will use strict HKSJ but ensure it doesn't break on k=1.
    } else {
       var_hksj = 1/swRE; // Fallback
    }

    const seRE = Math.sqrt(var_hksj);
    
    // Critical value: t-distribution (df = k-1)
    // Approx t-value for 95% CI
    let tVal = 1.96;
    if(k <= 2) tVal = 12.7; // df=1
    else if(k === 3) tVal = 4.3; // df=2
    else if(k === 4) tVal = 3.18; 
    else if(k === 5) tVal = 2.77;
    else if(k < 10) tVal = 2.3;
    else tVal = 2.05; // Converges to 1.96

    return {
        mu: muRE,
        se_pool: seRE,
        tVal: tVal, // Pass for CI calc
        tau2: tau2,
        I2: I2,
        trials: data.map(d => ({ 
            id: d.id, 
            or: Math.exp(d[kEff]), 
            lo: Math.exp(d[kEff] - 1.96*d[kSe]),
            hi: Math.exp(d[kEff] + 1.96*d[kSe]),
            active: d.active 
        }))
    };
  }

  function downsample(arr, n) {
    if(arr.length <= n) return arr;
    const res = [];
    const step = Math.floor(arr.length/n);
    for(let i=0; i<n; i++) res.push(arr[i*step]);
    return res;
  }
</script>

<script>
  /* --- DATABASE --- */
  const DB = [
    { id: "PRAMI",      tag: "Stable", n: 465,  logOR_eff: Math.log(0.35), se_eff: 0.25, logOR_saf: Math.log(1.00), se_saf: 0.30, active: true },
    { id: "CvLPRIT",    tag: "Stable", n: 296,  logOR_eff: Math.log(0.45), se_eff: 0.28, logOR_saf: Math.log(1.00), se_saf: 0.35, active: true },
    { id: "DANAMI-3",   tag: "Stable", n: 627,  logOR_eff: Math.log(0.66), se_eff: 0.20, logOR_saf: Math.log(1.10), se_saf: 0.25, active: true },
    { id: "COMPARE",    tag: "Stable", n: 885,  logOR_eff: Math.log(0.40), se_eff: 0.18, logOR_saf: Math.log(1.05), se_saf: 0.22, active: true },
    { id: "COMPLETE",   tag: "Stable", n: 4041, logOR_eff: Math.log(0.74), se_eff: 0.11, logOR_saf: Math.log(1.00), se_saf: 0.10, active: true }, // Verified vs Primary Manuscript
    { id: "FIRE",       tag: "Stable", n: 1445, logOR_eff: Math.log(0.73), se_eff: 0.10, logOR_saf: Math.log(0.70), se_saf: 0.10, active: false }, // Tightened SE from reported CI
    { id: "CULPRIT-SHOCK", tag: "Shock", n: 706, logOR_eff: Math.log(0.85), se_eff: 0.18, logOR_saf: Math.log(1.20), se_saf: 0.08, active: false } // RR 0.83 Inverted -> 1.20. Tight SE.
  ];

  /* --- STATE --- */
  let state = {
    trials: JSON.parse(JSON.stringify(DB)),
    baselineRisk: 0.05,
    harmPenalty: 1.0,
  };

  /* --- WORKER --- */
  const blob = new Blob([document.getElementById('worker-code').textContent], {type: "text/javascript"});
  const worker = new Worker(window.URL.createObjectURL(blob));
  
  worker.onmessage = function(e) {
    if(e.data.results) {
        renderUI(e.data.results);
        document.getElementById('runBtn').classList.remove('processing');
        document.getElementById('runBtn').disabled = false;
    }
  };

  /* --- ACTIONS --- */
  function loadPreset(type) {
    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(type === 'critique' ? 'btnCritique' : type === 'jacc' ? 'btnJacc' : type === 'shock' ? 'btnShock' : 'btnAll').classList.add('active');

    // Reset
    state.trials = JSON.parse(JSON.stringify(DB));
    
    if (type === 'critique') {
        // Consensus: Exclude FIRE (NSTEMI), Exclude CULPRIT (Shock)
        toggleTrialState('FIRE', false);
        toggleTrialState('CULPRIT-SHOCK', false);
        setRisk(5);
    } 
    else if (type === 'jacc') {
        // JACC: Includes FIRE, Excludes CULPRIT
        toggleTrialState('FIRE', true);
        toggleTrialState('CULPRIT-SHOCK', false);
        setRisk(8);
    }
    else if (type === 'shock') {
        // CULPRIT Only focus
        state.trials.forEach(t => t.active = false);
        toggleTrialState('CULPRIT-SHOCK', true);
        // Maybe some others have shock subgroups, but let's keep it pure for demo
        setRisk(35); // High risk
    }
    else {
        // All
        state.trials.forEach(t => t.active = true);
        setRisk(10);
    }
    
    renderTrialList();
    runSimulation();
  }

  function toggleTrialState(id, forceState) {
    const t = state.trials.find(x => x.id === id);
    if(t) t.active = (forceState !== undefined) ? forceState : !t.active;
  }

  function setRisk(val) {
    state.baselineRisk = val / 100;
    document.getElementById('riskInput').value = val;
    document.getElementById('lblRisk').textContent = val + "%";
  }

  function runSimulation() {
    document.getElementById('runBtn').classList.add('processing');
    document.getElementById('runBtn').disabled = true;

    worker.postMessage({
        trials: state.trials,
        baselineRisk: parseFloat(document.getElementById('riskInput').value)/100,
        harmPenalty: parseFloat(document.getElementById('harmInput').value),
        nSims: 20000
    });
  }

  /* --- RENDERERS --- */
  function renderTrialList() {
    const list = document.getElementById('trialList');
    list.innerHTML = '';
    state.trials.forEach(t => {
        const div = document.createElement('div');
        div.className = `trial-row ${t.active ? '' : 'excluded'}`;
        div.onclick = () => { t.active = !t.active; renderTrialList(); runSimulation(); };
        
        div.innerHTML = `
          <div>
            <span class="trial-name">${t.id}</span>
            <span class="trial-tag ${t.tag === 'Shock' ? 'tag-shock' : 'tag-stable'}">${t.tag}</span>
          </div>
          <div class="trial-meta">N=${t.n}</div>
        `;
        list.appendChild(div);
    });
  }

  function renderUI(res) {
    // Metrics
    const orEff = Math.exp(res.maEff.mu).toFixed(2);
    const orSaf = Math.exp(res.maSaf.mu).toFixed(2);
    
    document.getElementById('valEffOR').textContent = orEff;
    document.getElementById('valSafOR').textContent = orSaf;
    
    // HKSJ CI calc
    const tVal = res.maEff.tVal;
    const ciEffLo = Math.exp(res.maEff.mu - tVal*res.maEff.se_pool).toFixed(2);
    const ciEffHi = Math.exp(res.maEff.mu + tVal*res.maEff.se_pool).toFixed(2);
    document.getElementById('valEffCI').textContent = `${ciEffLo} - ${ciEffHi}`;

    const ciSafLo = Math.exp(res.maSaf.mu - tVal*res.maSaf.se_pool).toFixed(2);
    const ciSafHi = Math.exp(res.maSaf.mu + tVal*res.maSaf.se_pool).toFixed(2);
    document.getElementById('valSafCI').textContent = `${ciSafLo} - ${ciSafHi}`;

    document.getElementById('valNCB').textContent = (res.meanNCB * 100).toFixed(1) + "%";
    
    // I2 Badge
    const i2 = Math.round(res.maEff.I2);
    const badge = document.getElementById('hetBadge');
    badge.textContent = `Heterogeneity I² = ${i2}%`;
    badge.style.color = i2 > 50 ? '#ef4444' : '#fbbf24';

    // Narrative Logic
    const prob = res.probComplete;
    const title = document.getElementById('narrativeTitle');
    const sub = document.getElementById('narrativeSub');
    
    if(prob > 0.8) {
        title.textContent = "Favors Complete Revascularization";
        title.style.color = "var(--complete)";
        sub.textContent = "Strong signal for reduction in recurrent events without excess mortality.";
    } else if (prob < 0.2) {
        title.textContent = "Favors Culprit-Only Strategy";
        title.style.color = "var(--culprit)";
        sub.textContent = "Safety risks (renal/death) outweigh the benefit of preventing future MI.";
    } else {
        title.textContent = "Clinical Equipoise (Uncertainty)";
        title.style.color = "#fbbf24";
        sub.textContent = "Trade-off between preventing MI and procedural risk is balanced.";
    }

    // Report
    let report = `STATISTICAL SUMMARY (HKSJ Adjusted):\n`;
    report += `> Efficacy Signal (MACE): OR ${orEff} [${ciEffLo}-${ciEffHi}]\n`;
    report += `> Hard Safety Signal (Death/Renal): OR ${orSaf} [${ciSafLo}-${ciSafHi}]\n`;
    report += `> Net Benefit: ${(res.meanNCB*100).toFixed(1)}% Absolute Difference\n\n`;
    
    if(state.trials.find(t=>t.id==='CULPRIT-SHOCK' && t.active)) {
        report += "CRITIQUE NOTE: Inclusion of CULPRIT-SHOCK introduces significant heterogeneity. The mortality harm signal in shock patients dilutes the benefit seen in stable STEMI trials.";
    } else if (state.trials.find(t=>t.id==='FIRE' && t.active)) {
        report += "CRITIQUE NOTE: Analysis driven by FIRE trial (NSTEMI/Elderly). Results may not generalize to younger STEMI populations or those with cardiogenic shock.";
    } else {
        report += "CONSENSUS CONFIG: Analysis restricted to stable STEMI trials (COMPLETE, PRAMI, etc). Shows consistent benefit for complete revascularization driven by re-infarction reduction.";
    }
    document.getElementById('reportContent').innerText = report;

    // Charts
    drawForest(res);
    drawWaffle(res);
    drawDist(res);
  }

  /* --- CANVAS DRAWING --- */
  function setupCanvas(id) {
    const c = document.getElementById(id);
    const dpr = window.devicePixelRatio || 1;
    const rect = c.getBoundingClientRect();
    c.width = rect.width * dpr;
    c.height = rect.height * dpr;
    const ctx = c.getContext('2d');
    ctx.scale(dpr, dpr);
    return { ctx, w: rect.width, h: rect.height };
  }

  function drawForest(res) {
    const { ctx, w, h } = setupCanvas('forestCanvas');
    const pad = { t: 40, b: 30, l: 100, r: 30 };
    
    // Scale: LogOR -1.0 to +1.0 (OR 0.37 to 2.7)
    const minX = -0.8, maxX = 0.8;
    const sx = v => pad.l + ((v - minX)/(maxX - minX)) * (w - pad.l - pad.r);
    
    // Draw Axis
    ctx.strokeStyle = '#333'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(sx(0), pad.t); ctx.lineTo(sx(0), h-pad.b); ctx.stroke();
    
    ctx.fillStyle = '#555'; ctx.textAlign = 'center'; ctx.font = '9px Inter';
    ctx.fillText("Favors Complete", sx(-0.4), h-5);
    ctx.fillText("Favors Culprit", sx(0.4), h-5);

    const rows = res.maEff.trials;
    const rowH = (h - pad.t - pad.b) / (rows.length + 2);

    rows.forEach((t, i) => {
        const y = pad.t + i*rowH + rowH/2;
        
        // Label
        ctx.fillStyle = t.active ? '#ddd' : '#555'; 
        ctx.textAlign = 'right'; 
        ctx.font = '10px Inter';
        ctx.fillText(t.id, pad.l - 10, y+3);

        if(t.active) {
            // Point Estimate (LogOR)
            const logOR = Math.log(t.or);
            const lo = Math.log(t.lo);
            const hi = Math.log(t.hi);

            ctx.strokeStyle = '#aaa'; ctx.beginPath();
            ctx.moveTo(sx(lo), y); ctx.lineTo(sx(hi), y); ctx.stroke();
            
            ctx.fillStyle = '#3b82f6';
            const sz = 4;
            ctx.fillRect(sx(logOR)-sz/2, y-sz/2, sz, sz);
        }
    });

    // Pooled Diamonds
    const yE = h - pad.b - rowH*1.5;
    const yS = h - pad.b - rowH*0.5;
    
    drawDiamond(ctx, res.maEff, yE, '#10b981', sx, "Pooled Efficacy (MACE)");
    drawDiamond(ctx, res.maSaf, yS, '#ef4444', sx, "Pooled Safety (Death)");
  }

  function drawDiamond(ctx, ma, y, color, sx, label) {
    const cx = sx(ma.mu);
    const hw = (sx(ma.mu + ma.tVal*ma.se_pool) - sx(ma.mu - ma.tVal*ma.se_pool))/2; // Use tVal for Diamond width too
    
    ctx.fillStyle = color; 
    ctx.beginPath();
    ctx.moveTo(cx - hw, y); ctx.lineTo(cx, y-5); ctx.lineTo(cx+hw, y); ctx.lineTo(cx, y+5); ctx.fill();
    
    ctx.fillStyle = color; ctx.textAlign = 'left';
    ctx.fillText(label, 10, y+3);
  }

  function drawWaffle(res) {
    const { ctx, w, h } = setupCanvas('waffleCanvas');
    const cols = 20, rows = 5; 
    const gap = 4;
    const sz = Math.min((w-(cols*gap))/cols, (h-(rows*gap))/rows)*0.6;
    
    const startX = (w - (cols*sz + (cols-1)*gap))/2;
    const startY = (h - (rows*sz + (rows-1)*gap))/2;
    
    let diff = res.meanNCB * 100;
    
    const n_mi = Math.round(res.baseRiskMI * 100); // Baseline MI events
    const n_safe = Math.round(res.baseRiskSafe * 100); // Baseline Safety events
    
    // Adjust for effect
    const eff_factor = Math.exp(res.maEff.mu);
    const saf_factor = Math.exp(res.maSaf.mu);
    
    const n_mi_new = n_mi * eff_factor;
    const n_safe_new = n_safe * saf_factor;
    
    const saved_mi = Math.max(0, n_mi - n_mi_new);
    const caused_harm = Math.max(0, n_safe_new - n_safe);
    
    let dots = [];
    // Green dots for saved MI
    for(let i=0; i<saved_mi; i++) dots.push('#10b981');
    // Red dots for caused Harm
    for(let i=0; i<caused_harm; i++) dots.push('#ef4444');
    // Grey dots for Neutral
    while(dots.length < 100) dots.push('#27272a');
    
    let k = 0;
    for(let r=0; r<rows; r++) {
        for(let c=0; c<cols; c++) {
            ctx.fillStyle = dots[k] || '#27272a';
            ctx.beginPath(); 
            ctx.arc(startX + c*(sz+gap), startY + r*(sz+gap), sz/2, 0, Math.PI*2);
            ctx.fill();
            k++;
        }
    }
    
    // Legend
    ctx.font = '10px Inter'; ctx.fillStyle = '#777'; ctx.textAlign='center';
    ctx.fillText(`Saved Ischemia: ~${Math.round(saved_mi)}`, w/3, h-10);
    ctx.fillText(`Excess Harm: ~${Math.round(caused_harm)}`, 2*w/3, h-10);
  }

  function drawDist(res) {
    const { ctx, w, h } = setupCanvas('distCanvas');
    const data = res.ncbDist;
    const pad = 20;
    
    // X axis: -0.1 to +0.1
    const minX = -0.15, maxX = 0.15;
    const sx = v => pad + ((v-minX)/(maxX-minX))*(w-2*pad);
    
    // Histogram
    const bins = 40;
    const hist = new Array(bins).fill(0);
    data.forEach(v => {
        let idx = Math.floor((v - minX)/(maxX-minX) * bins);
        if(idx>=0 && idx<bins) hist[idx]++;
    });
    const maxH = Math.max(...hist);
    
    const bw = (w-2*pad)/bins;
    
    hist.forEach((count, i) => {
        const val = minX + (i/bins)*(maxX-minX);
        const barH = (count/maxH)*(h-2*pad);
        
        ctx.fillStyle = val > 0 ? '#10b981' : '#ef4444';
        ctx.fillRect(pad + i*bw, h-pad-barH, bw-1, barH);
    });
    
    // Zero line
    ctx.strokeStyle = '#fff'; ctx.beginPath();
    ctx.moveTo(sx(0), pad); ctx.lineTo(sx(0), h-pad); ctx.stroke();
    
    ctx.fillStyle='#aaa'; ctx.textAlign='center'; ctx.font='10px Inter';
    ctx.fillText("Harm Favored", sx(-0.08), 15);
    ctx.fillText("Benefit Favored", sx(0.08), 15);
  }

  // Init
  document.getElementById('riskInput').addEventListener('input', (e) => {
      document.getElementById('lblRisk').textContent = e.target.value + "%";
      // Debounce
      runSimulation();
  });
  document.getElementById('harmInput').addEventListener('input', (e) => {
      document.getElementById('lblHarm').textContent = e.target.value + "x";
      runSimulation();
  });

  renderTrialList();
  loadPreset('critique'); // Default start
</script>
</body>
</html>
